<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TrainTimer</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: #fff;
      color: #000;
    }
    .hidden { display: none; }
    #timer {
      font-size: 4em;
      margin: 20px 0;
    }
    #status {
      font-size: 1.5em;
      margin: 10px 0;
    }
    button {
      font-size: 1.2em;
      padding: 10px 20px;
      margin: 10px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #333;
      color: #fff;
    }
    .red { background-color: #ff4d4d !important; }
    .yellow { background-color: #ffd633 !important; }
    .green { background-color: #66cc66 !important; }
  </style>
</head>
<body>
  <h1>TrainTimer</h1>

  <div id="setup">
    <label>Anzahl Übungen: <input type="number" id="exerciseCount" min="1" value="3" /></label>
    <br/><br/>
    <button onclick="setupExercises()">Weiter</button>
  </div>

  <form id="exerciseSetup" class="hidden"></form>

  <div id="controls" class="hidden">
    <button onclick="startTimer()">Start</button>
  </div>

  <div id="session" class="hidden">
    <div id="status"></div>
    <div id="timer">0</div>
    <button id="nextBtn" class="hidden" onclick="nextManual()">Weiter</button>
  </div>

  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script>
    let exercises = [];
    let currentExercise = 0;
    let currentSet = 1;
    let timerInterval;
    let manualMode = false;

    function setupExercises() {
      const count = document.getElementById("exerciseCount").value;
      const form = document.getElementById("exerciseSetup");
      form.innerHTML = "";

      for (let i = 0; i < count; i++) {
        form.innerHTML += `
          <fieldset style="margin:15px;padding:10px;border:1px solid #aaa;">
            <legend>Übung ${i+1}</legend>
            <label>Dauer (Sekunden): 
              <input type="number" name="duration${i}" min="0" value="30" />
            </label>
            <label>
              <input type="checkbox" name="manual${i}" /> Manuelles Weiterschalten
            </label>
          </fieldset>
        `;
      }
      form.classList.remove("hidden");
      document.getElementById("controls").classList.remove("hidden");
    }

    function startTimer() {
      const form = document.getElementById("exerciseSetup");
      const count = document.getElementById("exerciseCount").value;
      exercises = [];
      for (let i = 0; i < count; i++) {
        const duration = parseInt(form[`duration${i}`].value) || 0;
        const manual = form[`manual${i}`].checked;
        exercises.push({duration, manual});
      }
      document.getElementById("setup").classList.add("hidden");
      form.classList.add("hidden");
      document.getElementById("controls").classList.add("hidden");
      document.getElementById("session").classList.remove("hidden");
      currentExercise = 0;
      runExercise();
    }

    function runExercise() {
      if (currentExercise >= exercises.length) {
        document.getElementById("status").textContent = "Fertig! 🎉";
        document.getElementById("timer").textContent = "";
        document.body.className = "";
        return;
      }
      const ex = exercises[currentExercise];
      document.getElementById("status").textContent = `Übung ${currentExercise+1}`;
      document.body.className = "red";

      if (ex.manual) {
        manualMode = true;
        document.getElementById("timer").textContent = "⏸️ Warten";
        document.getElementById("nextBtn").classList.remove("hidden");
      } else {
        manualMode = false;
        document.getElementById("nextBtn").classList.add("hidden");
        startCountdown(ex.duration, () => {
          beep();
          vibrate();
          currentExercise++;
          setTimeout(runExercise, 1000);
        });
      }
    }

    function nextManual() {
      beep();
      vibrate();
      document.getElementById("nextBtn").classList.add("hidden");
      currentExercise++;
      runExercise();
    }

    function startCountdown(seconds, callback) {
      let remaining = seconds;
      document.getElementById("timer").textContent = remaining;
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        remaining--;
        document.getElementById("timer").textContent = remaining;
        if (remaining <= 5 && remaining > 0) beep();
        if (remaining <= 0) {
          clearInterval(timerInterval);
          callback();
        }
      }, 1000);
    }

    function beep() {
      document.getElementById("beep").play();
    }

    function vibrate() {
      if ("vibrate" in navigator) navigator.vibrate(500);
    }
  </script>
</body>
</html>
